name: Run Maester ðŸ”¥

on:
  push:
    branches:
      - main

  schedule:
    # Daily at 7:30 UTC, change accordingly
    - cron: "30 7 * * *"

  # Allows to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Run Maester ðŸ”¥
        id: maester
        # Set the action version to a specific version, to keep using that exact version.
        uses: lilian-17/maester-action@main
        with:
          tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          client_id: ${{ secrets.AZURE_CLIENT_ID }}
          include_public_tests: false
          include_private_tests: true
          include_exchange: true
          include_teams: false
          # Set a specific version of the powershell module here or 'latest' or 'preview'
          # check out https://www.powershellgallery.com/packages/Maester/
          maester_version: latest
          disable_telemetry: false
          step_summary: true
          #Mails

          
      - name: Write status ðŸ“ƒ
        shell: bash
        run: |
          echo "The result of the test run is: ${{ steps.maester.outputs.result }}"
          echo "Total tests: ${{ steps.maester.outputs.tests_total }}"
          echo "Passed tests: ${{ steps.maester.outputs.tests_passed }}"
          echo "Failed tests: ${{ steps.maester.outputs.tests_failed }}"
          echo "Skipped tests: ${{ steps.maester.outputs.tests_skipped }}"

      - name: Run and Mail Results ðŸ“¨
        shell: pwsh
        run: |
          Connect-Maester -TenantId $env:AZURE_TENANT_ID -ClientId $env:AZURE_CLIENT_ID -ClientSecret $env:AZURE_CLIENT_SECRET
          # Construire l'URL du run GitHub
          $testResultsUri = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Lancer les tests personnalisÃ©s dans le dossier "Tests" et rÃ©cupÃ©rer les rÃ©sultats
          $results = Invoke-Maester -Path "Tests" -PassThru

          # Envoyer les rÃ©sultats par mail
          Send-MtMail -MaesterResults $results `
                      -Recipient "lilian.martpro@gmail.com" `
                      -UserId "40f9d246-a922-40f5-bf15-6e686f0711d7" `
                      -TestResultsUri $testResultsUri


